{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://modellm.example.com/schemas/pipeline_config.schema.json",
  "title": "Prompt Pipeline Configuration Schema",
  "description": "Schema for validating prompt pipeline configuration files with enhanced input/output system and compression support",
  "type": "object",
  "properties": {
    "cli_inputs": {
      "type": "array",
      "description": "CLI input specifications (interactive inputs)",
      "items": {
        "type": "object",
        "required": ["label", "type", "prompt"],
        "properties": {
          "label": {
            "type": "string",
            "description": "Unique identifier for this input (used in prompts as {{label}})",
            "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
          },
          "type": {
            "type": "string",
            "description": "Input content type",
            "enum": ["md", "yaml", "json", "text", "typedb_query", "typedb_result"]
          },
          "prompt": {
            "type": "string",
            "description": "Prompt message displayed to user"
          },
          "required": {
            "type": "boolean",
            "description": "Whether this input is required",
            "default": true
          },
          "default_file": {
            "type": "string",
            "description": "Optional default file path for this input"
          }
        },
        "additionalProperties": false
      },
      "uniqueItems": true
    },
    "exogenous_inputs": {
      "type": "array",
      "description": "External input files that are available to steps",
      "items": {
        "type": "object",
        "required": ["file", "label"],
        "properties": {
          "file": {
            "type": "string",
            "description": "Path to the external input file"
          },
          "label": {
            "type": "string",
            "description": "Unique identifier for this input (used in prompts as {{label}})",
            "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
          }
        },
        "additionalProperties": false
      },
      "uniqueItems": true
    },
    "output_labels": {
      "type": "array",
      "description": "Output labels registry for cross-step references",
      "items": {
        "type": "object",
        "required": ["step", "label"],
        "properties": {
          "step": {
            "type": "string",
            "description": "Step name that produces this output"
          },
          "label": {
            "type": "string",
            "description": "Unique identifier for the output (used in prompts as {{label}})",
            "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
          }
        },
        "additionalProperties": false
      },
      "uniqueItems": true
    },
    "steps": {
      "type": "object",
      "description": "Step configurations for the pipeline",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "object",
          "required": ["name", "prompt_file", "order", "inputs", "outputs"],
          "properties": {
            "name": {
              "type": "string",
              "description": "Human-readable name for the step"
            },
            "prompt_file": {
              "type": "string",
              "description": "Path to the prompt template file"
            },
            "order": {
              "type": "integer",
              "description": "Execution order of the step",
              "minimum": 1
            },
            "inputs": {
              "type": "array",
              "description": "Input configuration for this step",
              "items": {
                "type": "object",
                "required": ["label", "type", "source"],
                "properties": {
                  "label": {
                    "type": "string",
                    "description": "Input identifier (references cli_inputs, exogenous_inputs, or previous step outputs)"
                  },
                  "type": {
                    "type": "string",
                    "description": "Input content type",
                    "enum": ["md", "yaml", "json", "text", "typedb_query", "typedb_result"]
                  },
                  "source": {
                    "type": "string",
                    "description": "Input source: cli, file, or label:NAME",
                    "pattern": "^(cli|file|label:[a-zA-Z_][a-zA-Z0-9_]*|typedb)$"
                  },
                  "compression": {
                    "type": "string",
                    "description": "Compression strategy to apply to input before substitution",
                    "enum": ["full", "anchor_index", "concept_summary", "hierarchical", "schema_only", "differential", "none"]
                  },
                  "color": {
                    "type": "string",
                    "description": "Terminal color for showing substitutions",
                    "enum": ["cyan", "green", "yellow", "magenta", "red", "blue", "white"]
                  }
                },
                "additionalProperties": false
              },
              "minItems": 1
            },
            "outputs": {
              "type": "array",
              "description": "Output configuration for this step",
              "items": {
                "type": "object",
                "required": ["file", "label", "type"],
                "properties": {
                  "file": {
                    "type": "string",
                    "description": "Path to the output file"
                  },
                  "label": {
                    "type": "string",
                    "description": "Unique label for this output (used by other steps to reference it)"
                  },
                  "type": {
                    "type": "string",
                    "description": "Output content type",
                    "enum": ["md", "yaml", "json", "text"]
                  }
                },
                "additionalProperties": false
              },
              "minItems": 1
            },
            "dependencies": {
              "type": "array",
              "description": "Step dependencies (inferred from input labels, but can be explicitly specified)",
              "items": {
                "type": "string",
                "description": "Name of a step this step depends on"
              }
            },
            "validation": {
              "type": "object",
              "description": "Validation configuration for this step",
              "properties": {
                "schema": {
                  "type": ["string", "null"],
                  "description": "Path to JSON Schema file for validating output"
                },
                "enabled": {
                  "type": "boolean",
                  "description": "Whether to enable validation for this step",
                  "default": true
                }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "model_levels": {
      "type": "object",
      "description": "Model level configurations for each step",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "object",
          "description": "Model levels for a specific step",
          "properties": {
            "1": {
              "type": "string",
              "description": "Model for level 1 (cheapest/fastest)"
            },
            "2": {
              "type": "string",
              "description": "Model for level 2 (balanced)"
            },
            "3": {
              "type": "string",
              "description": "Model for level 3 (best/production)"
            }
          },
          "additionalProperties": false,
          "required": ["1", "2", "3"]
        }
      },
      "additionalProperties": false
    },
    "dev_defaults": {
      "type": "object",
      "description": "Development defaults",
      "properties": {
        "model_level": {
          "type": "integer",
          "description": "Default model level (1-3)",
          "minimum": 1,
          "maximum": 3
        },
        "verbosity": {
          "type": "integer",
          "description": "Default verbosity level (0-3)",
          "minimum": 0,
          "maximum": 3
        },
        "skip_validation": {
          "type": "boolean",
          "description": "Whether to skip validation by default",
          "default": false
        }
      },
      "additionalProperties": false
    }
  },
  "required": ["steps"],
  "additionalProperties": false
}
